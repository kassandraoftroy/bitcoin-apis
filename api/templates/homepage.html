<head>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
</head>

<h1 style='text-align: center;'> Murmur Bitcoin Demo </h1>

<button id='create'>create a murmur wallet</button> <br><br><br>

Sender:&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" name="" id='sender' size='36'><br>
Reciever:&nbsp;<input type="text" name="" id='receiver' size='36'><br>
Amount:&nbsp;&nbsp;<input type="text" name="" id='amount' size='12'><br>
Fee:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" name="" id='fee' size='12'><br>
<button id='start_button'>start</button>

<p id='log' style='word-wrap: break-word;'></p>

<script>
	var text = "";
	var n = 0;
	document.getElementById('start_button').onclick = function () {
		var sender = $('#sender').val();
		var fee = $('#fee').val();
		var receiver = $('#receiver').val();
		var amount = $('#amount').val();
		var sig_hashes = [];
		$.ajax({
			url: "{% url 'prepare_signature' %}",
			data: {'sender': sender, 'amount':amount, 'receiver':receiver, 'fee':fee},
			success: function (data){
				sig_hashes = data.hashes;
				text += "[log] creating transaction: " + data.unsigned + "<br><br>";
				for (i = 0; i < sig_hashes.length; i++) {
					n = i+1;
				    text += "[log] hash #" + n.toString() + ": " +sig_hashes[i] +  "<br>";
				}
				document.getElementById('log').innerHTML = text;
				initECDSA(sig_hashes, data.unsigned)
			}
		});
	}

	function initECDSA (hashes, unsigned) {
		text += "<br>[log] initializing homomorphic signature operation with murmur...";
		document.getElementById('log').innerHTML = text;
		for (i = 0; i < hashes.length; i++) {
			n = i+1
			/* call murmur api here once for each signature */
		}
	}

	document.getElementById('create').onclick = function () {
		a = "";
		b = "";
		addr = "";
		$.ajax({
			url: '{% url "newmurmur" %}',
			data: {"IdentityKey": "newId"},
			success: function (data){
				text += "[log] new murmur channel created: " + data.ChannelId + "<br>";
				text += "[log] storing private key...<br>";
				document.getElementById('log').innerHTML = text;
			},
		});
		$.ajax({
			url: "{% url 'get_testwallet' %}",
			success: function (data){
				text += "[log] new wallet created! <br>[log] address: " + data.address + "<br>";
				text += "[log] <a target='_blank' href='https://testnet.blockchain.info/address/"+data.address+"'> see here</a><br><br>";
				document.getElementById('log').innerHTML = text;
				$('#sender').val(data.address);
				$('#receiver').val("mfeVwF1taoNGJpT2ozRpuqpYqp37t42SMy");
				$('#amount').val("0.099999");
				$('#fee').val("0.000001");
				a = data.priv;
				b = data.pub;
				addr = data.address;
			}
		});
		setTimeout(function (){
			console.log(a);
			$.ajax({
				url: '{% url "write" %}',
				data: {"key": a, "name": "asdf"},
				success: function(data){
					text += "[log] "+ data.status +" <br><br>";
					document.getElementById('log').innerHTML = text;
				}
			});			
		}, 1000);
		$.ajax({
			url: "{% url 'fund_wallets' %}",
			success: function(data){
				console.log(data)
			}
		});
		setTimeout(function (){
			$.ajax({
				url: '{% url "access" %}',
				data: {"name": "asdf"},
				success: function(data){
					text += "[log] access check! "+ data.Content +" <br";
					document.getElementById('log').innerHTML = text;
				}
			});			
		}, 1000);
	}

</script>